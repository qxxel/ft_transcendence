
export class	TankGame {
  private	isPaused: boolean = false;
  private	isGameOver: boolean = false;
  private	startTime: number = 0;
  private	canvas: HTMLCanvasElement | null = null;
  private	ctx: CanvasRenderingContext2D | null = null;
  private	animationFrameId: number | null = null;
  private	ids: { canvas: string; score1: string; score2: string; winScore: string };
  private	keysPressed: { [key: string]: boolean } = {};

  constructor(
    canvasId: string, 
    score1Id: string, 
    score2Id: string, 
    winScoreId: string, 
    gameMode: 'pvp' | 'ai' = 'ai'
  ) {
    this.ids = {
      canvas: canvasId,
      score1: score1Id,
      score2: score2Id,
      winScore: winScoreId
    };
    this.canvas! = document.getElementById(this.ids.canvas) as HTMLCanvasElement;
    this.ctx = this.canvas.getContext('2d');

    this.handleKeyDown = this.handleKeyDown.bind(this);
    this.handleKeyUp = this.handleKeyUp.bind(this);
  }


  // Main game loop that runs at ~60 FPS - updates game state and renders graphics
  private	gameLoop() {
    this.update();
    this.draw();
    this.animationFrameId = requestAnimationFrame(() => this.gameLoop());
  }

  private	update() {
    // if (this.isPaused || this.isGameOver) { return; }
    // console.log("keyPressed:", key);
    // console.log("now:", Date.now());

  }


  private	handleKeyDown(e: KeyboardEvent) {
    if (this.isGameOver && e.key === ' ') {
        this.restart();
        return;
    }

    if (e.key === 'Escape' && !this.isGameOver) {
      this.isPaused = !this.isPaused;
    }
    
    this.keysPressed[e.key] = true;
  }

  private	handleKeyUp(e: KeyboardEvent) {
    this.keysPressed[e.key] = false;
  }

  public	start() {
    if (!this.animationFrameId) {
      this.startTime = Date.now();
      window.addEventListener('keydown', this.handleKeyDown);
      window.addEventListener('keyup', this.handleKeyUp);
      this.gameLoop();
      console.log('Game Started');
    }
  }

  private	restart() {

    this.isGameOver = false;
    this.isPaused = false;

    this.startTime = Date.now();

    const dashboard = document.getElementById('game-over-dashboard');
    if (dashboard) {
        dashboard.style.display = 'none';
    }

  }

  public	stop() {
    if (this.animationFrameId) {
      cancelAnimationFrame(this.animationFrameId);
      window.removeEventListener('keydown', this.handleKeyDown);
      window.removeEventListener('keyup', this.handleKeyUp);
      this.animationFrameId = null;
      console.log('Game Stopped');
    }
  }


  private	draw() {
    this.ctx!.fillStyle = '#000';
    this.ctx!.fillRect(0, 0, this.canvas!!.width, this.canvas!!.height);

    this.ctx!.fillStyle = '#fff';

    if (this.isPaused && !this.isGameOver) {
      this.ctx!.fillStyle = 'rgba(0, 0, 0, 0.5)';
      this.ctx!.fillRect(0, 0, this.canvas!.width, this.canvas!.height);
      this.ctx!.fillStyle = 'white';
      this.ctx!.font = '50px monospace';
      this.ctx!.textAlign = 'center';
      this.ctx!.fillText('PAUSED', this.canvas!.width / 2, this.canvas!.height / 2);
    }
  }

}

